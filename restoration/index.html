<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10000 Cents</title>

    <style>
       * {
          shape-rendering: crispEdges;
        }

        body{
          background-color: black;
        }
        #bill_container{
          width:100%;
          display: flex;
          justify-content: center;
/*cursor: none;*/
        }
        #bill{
          margin: 0;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 862px!important;
          height: 402px!important

        }
  
    </style>

    </head>

    <body>

    
        <svg id="bill" >

          <g  id="videoContainer">
            <foreignobject  id="billForeignObject" x="0" y="0" width="801" height="342">
              <video width="800" height="342" autoplay="true" muted="true" >
                <source src="assets/bill_convert.mp4" type="video/mp4">
              </video>
            </foreignobject>
            <g  id="billContainer"></g>

          </g>

        </svg> 
 

      <script>
        
        /* VARIABLE DECLARATIONS */
        var actualBillHeight = 342;
        var actualBillWidth = 801;

        // General Variables
        var svgns = "http://www.w3.org/2000/svg";
        var showGrid = false

        // Sets height of the red cursor
        var individualImageWidth = 8;
        var individualImageHeight = 4;

        // Sets overal size of the bill for internal calculations
        var billHeight =individualImageHeight * 100; 
        var billWidth = individualImageWidth * 100;
        
        // The grid we use to select and display individual images has an overlap pattern. This sets it.
        var overlapX = 1
        var overlapY = [3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4]
        var selectedRect = null;
        var clickedRect = null; 

        // Sets the variables used to create the popup draing box
        var popupHeight = 90;
        var popupWidth = 406;

        var edgeMargin = 30;
        var edgeMarginY = 30;

        var popupSideHeight = 84
        var popupSideWidth = 203
        var popupSideMargin = 2

        var overhangCorrection = 5

        var timeout;

        /* ------------------------------------------------------------------------------------------------------------------------------------------------------ */

       
        /* DEBUG */

        // FOR DEBUG ONLY, overlays the grid on the bill
        document.onkeypress = function (e) {
            e = e || window.event;
            if (e.keyCode == 99){
              showGrid = !showGrid
              highlights = document.getElementsByClassName('cell')
              if (showGrid){
                for (var i = 0; i < highlights.length; i++){
                  highlights[i].style = 'fill: rgb(255,255,255,0); stroke: red; stroke-width: 1'
                }
              }
             else{
                for (var i = 0; i < highlights.length; i++){
                  highlights[i].style = 'fill: rgb(255,255,255,0); stroke: red; stroke-width: 0'
                }
              }
            }
        };

        /* ------------------------------------------------------------------------------------------------------------------------------------------------------ */

        
        /* GENERAL FUNCTIONS */

        /* Fetches the local instruction file*/
        function readTextFile(file) {
          var rawFile = new XMLHttpRequest();
          rawFile.open("GET", file, false);
          rawFile.onreadystatechange = function () {
            if(rawFile.readyState === 4)  {
              if(rawFile.status === 200 || rawFile.status == 0) {
                var allText = rawFile.responseText;
              }
            }
          }
          rawFile.send(null);
        }
        
        /* Converts rgb color code to hex */
        function rgbToHex(r, g, b) {
          return "#" + (1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1);
        }
        
        /* ------------------------------------------------------------------------------------------------------------------------------------------------------ */


        /* Creates the grid that will ovrlay the bill and allow us to select particular images*/
        function setupBillSize(){
          
          var bill = document.getElementById('bill')
          bill.style.width = `${billWidth+(edgeMargin*2)}px`
          bill.style.height = `${billHeight+ (edgeMargin*2)}px`

          var billLoadForeignObject = document.getElementById('billForeignObject')
          billLoadForeignObject.setAttribute('x', edgeMargin)
          billLoadForeignObject.setAttribute('y', edgeMargin)

          overlapYPos = 0

          y = edgeMargin + 1
       
          for (var i = 1; i <= 100; i++){
              x = edgeMargin 
            
              for (var j = 1; j <= 100; j++){
                  
                  var rect = document.createElementNS(svgns, 'rect');
                  rect.id = `${j}.${i}`
                  rect.setAttribute('class', 'cell')
                  rect.setAttributeNS(null, 'x', x);
                  rect.setAttributeNS(null, 'y', y);
                  rect.setAttributeNS(null, 'height', individualImageHeight);
                  rect.setAttributeNS(null, 'width', individualImageWidth);
                  rect.style = 'fill: rgb(255,255,255,0); '
                  document.getElementById('billContainer').appendChild(rect);
                  x += individualImageWidth  
              }
             
           
               if (i!= 1 && i != 100){
                y += overlapY[overlapYPos]
                overlapYPos += 1
       
               }
              else{
                y += individualImageHeight
               }
           
          }
      }

    

        function getBillCoordinates(){
          return {'x1': edgeMargin, 'y1': edgeMarginY}
        }

        function createPopUpBox(clickedImage){
          billPosition = getBillCoordinates()
          clearInterval(timeout)
          clickedImage = event.srcElement
          
          clickedX = clickedImage.getAttribute('x')

          clickedY = clickedImage.getAttribute('y')
          console.log(`initial clicked x ${clickedX} y: ${clickedY}`)

          if (clickedY > edgeMarginY + (billHeight/2)){
            adjustedX = parseInt(clickedX) - popupWidth/2 + 5
            adjustedY = parseInt(clickedY) - parseInt(popupHeight)- 10
            console.log("bottom?")
          }

          else{
            console.log('top')
            adjustedX = parseInt(clickedX) - popupWidth/2 + 5
            adjustedY = parseInt(clickedY) +6 + 6
            console.log(clickedY)
          }

          if (clickedX < edgeMargin + 180){
            adjustedX = edgeMargin - 23
          }
          
          if (clickedX > edgeMargin + (billWidth - 180)){
            adjustedX = edgeMargin  + (billWidth - 180) - popupWidth/2
          }

          adjustedPosition = {'x': adjustedX, 'y': adjustedY}
          console.log(`adjusted position x: ${adjustedX} y: ${adjustedY}`)

          var svgns = "http://www.w3.org/2000/svg";
          var popupContainer = document.createElementNS(svgns, 'g');
          popupContainer.id = "popupContainer"
          popupContainer.style = 'fill: rgb(255,255,255,1);'
          
          var popup = document.createElementNS(svgns, 'rect');
          popup.id = 'popup'
          popup.setAttributeNS(null, 'x', adjustedPosition.x);
          popup.setAttributeNS(null, 'y', adjustedPosition.y);
          popup.setAttributeNS(null, 'height', popupHeight);
          popup.setAttributeNS(null, 'width', popupWidth);
          popup.style = 'fill: rgb(255,255,255,1);'
          popupContainer.appendChild(popup)
          console.log(popup)
         /* var pointer = document.createElementNS(svgns, 'polygon');
          pointer.id = 'pointer'
          pointer.style.fill = "white"

          if (position.includes('top')){
            pointer.setAttribute('points', `${clickedElementPosition.x + 4} ${adjustedPosition.y}, ${clickedElementPosition.x + individualImageWidth/2 + 3 } ${adjustedPosition.y-7}, ${clickedElementPosition.x + individualImageWidth + 2} ${adjustedPosition.y}`)
          }

          else{
            pointer.setAttribute('points', `${clickedElementPosition.x + 4} ${adjustedPosition.y+90}, ${clickedElementPosition.x + individualImageWidth/2 + 3 } ${adjustedPosition.y+97}, ${clickedElementPosition.x + individualImageWidth + 2} ${adjustedPosition.y+90}`)
          }

          document.getElementById('billContainer').appendChild(pointer)
*/
       

          var popupRightSide = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          popupRightSide.id = 'drawingContainer'
          popupRightSide.setAttributeNS(null, 'x', (adjustedPosition.x + popupSideWidth)  - popupSideMargin  -1 );
          popupRightSide.setAttributeNS(null, 'y', adjustedPosition.y+popupSideMargin+1);
          popupRightSide.setAttributeNS(null, 'height', popupSideHeight);
          popupRightSide.setAttributeNS(null, 'width', popupSideWidth);
          popupRightSide.setAttributeNS(null, 'href', `data/images/${clickedImage.id}.jpg`);
          popupContainer.appendChild(popupRightSide);
          
          var popupLeftSide = document.createElementNS('http://www.w3.org/2000/svg', 'image');
          popupLeftSide.id = `popupLeftSide`
          popupLeftSide.setAttributeNS(null, 'x', (adjustedPosition.x) + popupSideMargin -1);
          popupLeftSide.setAttributeNS(null, 'y', adjustedPosition.y+popupSideMargin + 1);
          popupLeftSide.setAttributeNS(null, 'height', popupSideHeight+1);
          popupLeftSide.setAttributeNS(null, 'width', popupSideWidth  );
          popupLeftSide.setAttributeNS(null, 'href', `data/images/${clickedImage.id}.jpg`);
          popupContainer.appendChild(popupLeftSide);
          console.log(popupLeftSide)
       

          var background = document.createElementNS(svgns, 'rect');
          background.setAttributeNS(null, 'x',0);
          background.setAttributeNS(null, 'y', 0);
          background.setAttributeNS(null, 'height', popupSideHeight);
          background.setAttributeNS(null, 'width', popupSideWidth);
          background.style = ' fill: white;'

          popupRightSide.append(background)

          var popupInnerBox = document.createElementNS(svgns, 'rect');
          popupInnerBox.id = 'popupInnerBox'
          popupInnerBox.setAttributeNS(null, 'x', adjustedPosition.x+popupSideMargin+1);
          popupInnerBox.setAttributeNS(null, 'y', adjustedPosition.y+popupSideMargin+1);
          popupInnerBox.setAttributeNS(null, 'height', popupHeight-(popupSideMargin*2)-1);
          popupInnerBox.setAttributeNS(null, 'width', popupWidth-(popupSideMargin*2)-1);
          popupInnerBox.style = ' fill:rgb(255,255,255,0); stroke: rgb(175,175,175); stroke-width: 1px'
          popupContainer.appendChild(popupInnerBox)



          popupContainer.drawing = true
          fetch(`data/drawing_instructions/${clickedImage.id}.txt`)
          .then((res) => res.text())
          .then((text) => {
            function parseCommand(i) {
            
          
              if ( i < commands.length - 1){

                command = commands[i]
                if (command.length > 0){
                  parts = commands[i].split(".")
                  
                  if (parts[0] == 'c'){
                    color = rgbToHex(parts[1], parts[2], parts[3])
                  }

                  else{
                    if (parts[0] == 's'){
                      thickness= (parts[1] / 0.85) * scale
                    }

                    else {
                        thickness = thickness
                        var newLine = document.createElementNS('http://www.w3.org/2000/svg','line');
                        
                        newLine.setAttribute('x1', parts[0] * scale);
                        newLine.setAttribute('y1', parts[1] * scale);
                        newLine.setAttribute('x2',  (parts[2]) * scale );
                        newLine.setAttribute('y2',(parts[3] * scale));
                        newLine.setAttribute('stroke-linecap', "round");
                        newLine.style = ` stroke:${color}; stroke-width: ${thickness}; `
                      
                        var container = document.getElementById('drawingContainer')
                        container.appendChild(newLine)
                        
                    }
                  }
                }
              }
              i++
              timeout = setTimeout(function () {
                  parseCommand(i);
              }, 6);
            }
            
            
            // do something with "text"
            commands = text.split("drawing=")[1]
            curCommand = 0;
            thickness = 1;
            color = 'black';
            scale = 0.5
            commands = commands.split("_");
            numCommands = commands.length;
            var i = 0;

            parseCommand(i)
          })
          .catch((e) => console.error(e));
        
          document.getElementById('bill').appendChild(popupContainer);
        
        }

        setupBillSize()
        
        function distance(x1, y1, x2, y2) {
          var dx = x1 - x2 
          var dy = y1 - y2 
          return Math.sqrt(dx*dx+dy*dy);
        }


        /* MOUSE FUNCTIONS */

        window.addEventListener('mousemove', function (event) {
          var offSetRect = document.getElementById('billContainer').getBoundingClientRect()
          const localX = event.clientX - offSetRect.left ;
          const localY = event.clientY - offSetRect.top  ;
          localMousePos = { x: localX, y: localY };
          
          overX = Math.floor((localX)/8)*8;
          overY = Math.floor((localY)/3.4)*3.4;

          overX = Math.round(overX * 10) / 10
          overY = Math.round(overY * 10) / 10;

        

          rectX = (overX/8) + 1
          rectY = (overY/3.4) + 1

          rectX = Math.floor(rectX)
          rectY = Math.floor(rectY)

          id = `${rectX}.${rectY}`

          if (selectedRect != null){
              selectedRect.style= "fill: rgb(255,255,255,0);  stroke:red; stroke-width:0";
          }

          if (clickedRect != null){
            clickedRect.style="fill:red; stroke:red; stroke-width:1; "
          }

          if (overX > -1 && overY > -1 && overX <= actualBillWidth && overY <= actualBillHeight){
            console.log(`x within bill: ${localX}, y within bill: ${localY}`)
            console.log(`adjusted x: ${overX} adjusted y: ${overY}`)

            if (clickedRect != null){
              distanceClick = distance(clickedRect.getAttribute('x'), clickedRect.getAttribute('y'), localX+edgeMargin, localY+edgeMarginY)

             if ( distanceClick > 10 ) {
                clickedRect.style = "fill: rgb(255,255,255,0);  stroke:red; stroke-width:0";
                clickedRect = null;
                selectedRect.style= "fill: rgb(255,255,255,0);  stroke:red; stroke-width:0";
                    var alreadyExists = document.getElementById('popupContainer');
                  var parent = alreadyExists.parentNode
                  parent.removeChild(alreadyExists)
                 /* var pointer = document.getElementById('pointer');
                  var pointerParent = pointer.parentNode
                  pointerParent.removeChild(pointer)*/
                clearInterval(timeout)
              }
 
              
            }
            
           
            selectedRect = document.getElementById(id)
            if (selectedRect != clickedRect){
              selectedRect.style = "fill: rgb(255,255,255,0);  stroke:red; stroke-width:1";

            }
          

          }
          

         
            
         
        
        }, false);


        
      document.getElementById('bill').addEventListener('click', function (event) {
        if (overX > -1 && overY > -1 && overX <= actualBillWidth && overY <= actualBillHeight){
          if (clickedRect != null){
            clickedRect.style= "fill: rgb(255,255,255,0);  stroke:red; stroke-width:0";
          } 
          clickedRect = selectedRect
          clickedRect.style="fill:red; stroke:red; stroke-width:1; "
         
          if (document.getElementById('popupContainer') != null ){
                var alreadyExists = document.getElementById('popupContainer');
                var parent = alreadyExists.parentNode
                parent.removeChild(alreadyExists)
                /*var pointer = document.getElementById('pointer');
                var pointerParent = pointer.parentNode
                pointerParent.removeChild(pointer)
                */
              }
              clearInterval(timeout)
              createPopUpBox(event.srcElement)
        }

      }, false);

        /* ------------------------------------------------------------------------------------------------------------------------------------------------------ */

      </script>

    </body>

</html>