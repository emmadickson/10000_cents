<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10000 Cents</title>

    <style>
       * {
          shape-rendering: crispEdges;
        }

        body{
          background-color: black;
        }
        #bill_container{
          width:100%;
          display: flex;
          justify-content: center;
/*cursor: none;*/
        }
        #bill{
          margin: 0;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 862px!important;
          height: 402px!important

        }
  
    </style>

    </head>

    <body>

    
        <svg id="bill" >

          <g  id="videoContainer">
            <foreignobject  id="billForeignObject" x="0" y="0" width="801" height="342">
              <video width="800" height="342" autoplay="true" muted="true" >
                <source src="assets/bill_convert.mp4" type="video/mp4">
              </video>
            </foreignobject>
            <g  id="billContainer"></g>

          </g>

        </svg> 
 

      <script>
        
        /* VARIABLE DECLARATIONS */
        var actualBillHeight = 342;
        var actualBillWidth = 801;

        // General Variables
        var svgns = "http://www.w3.org/2000/svg";
        var showGrid = false

        // Sets height of the red cursor
        var individualImageWidth = 8;
        var individualImageHeight = 4;

        // Sets overal size of the bill for internal calculations
        var billHeight =individualImageHeight * 100; 
        var billWidth = individualImageWidth * 100;
        
        // The grid we use to select and display individual images has an overlap pattern. This sets it.
        var overlapX = 1
        var overlapY = [3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4,3,4,3,3,4]
        var selectedRect = null;
        var clickedRect = null; 

        // Sets the variables used to create the popup draing box
        var popupHeight = 90;
        var popupWidth = 405;

        var edgeMargin = 30;
        var edgeMarginY = 30;

        var popupSideHeight = 84
        var popupSideWidth = 202
        var popupSideMargin = 2

        var overhangCorrection = 5

        var timeout;

        /* ------------------------------------------------------------------------------------------------------------------------------------------------------ */

       
        /* DEBUG */

        // FOR DEBUG ONLY, overlays the grid on the bill
        document.onkeypress = function (e) {
            e = e || window.event;
            if (e.keyCode == 99){
              showGrid = !showGrid
              highlights = document.getElementsByClassName('cell')
              if (showGrid){
                for (var i = 0; i < highlights.length; i++){
                  highlights[i].style = 'fill: rgb(255,255,255,0); stroke: red; stroke-width: 1'
                }
              }
             else{
                for (var i = 0; i < highlights.length; i++){
                  highlights[i].style = 'fill: rgb(255,255,255,0); stroke: red; stroke-width: 0'
                }
              }
            }
        };

        /* ------------------------------------------------------------------------------------------------------------------------------------------------------ */

        
        /* GENERAL FUNCTIONS */

        /* Fetches the local instruction file*/
        function readTextFile(file) {
          var rawFile = new XMLHttpRequest();
          rawFile.open("GET", file, false);
          rawFile.onreadystatechange = function () {
            if(rawFile.readyState === 4)  {
              if(rawFile.status === 200 || rawFile.status == 0) {
                var allText = rawFile.responseText;
              }
            }
          }
          rawFile.send(null);
        }
        
        /* Converts rgb color code to hex */
        function rgbToHex(r, g, b) {
          return "#" + (1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1);
        }
        
        /* ------------------------------------------------------------------------------------------------------------------------------------------------------ */


        /* Creates the grid that will ovrlay the bill and allow us to select particular images*/
        function setupBillSize(){
          
          var bill = document.getElementById('bill')
          bill.style.width = `${billWidth+(edgeMargin*2)}px`
          bill.style.height = `${billHeight+ (edgeMargin*2)}px`

          var billLoadForeignObject = document.getElementById('billForeignObject')
          billLoadForeignObject.setAttribute('x', edgeMargin)
          billLoadForeignObject.setAttribute('y', edgeMargin)

          overlapYPos = 0

          y = edgeMargin + 1
       
          for (var i = 1; i <= 100; i++){
              x = edgeMargin 
            
              for (var j = 1; j <= 100; j++){
                  
                  var rect = document.createElementNS(svgns, 'rect');
                  rect.id = `${j}.${i}`
                  rect.setAttribute('class', 'cell')
                  rect.setAttributeNS(null, 'x', x);
                  rect.setAttributeNS(null, 'y', y);
                  rect.setAttributeNS(null, 'height', individualImageHeight);
                  rect.setAttributeNS(null, 'width', individualImageWidth);
                  rect.style = 'fill: rgb(255,255,255,0); '
                  document.getElementById('billContainer').appendChild(rect);
                  x += individualImageWidth  
              }
             
           
               if (i!= 1 && i != 100){
                y += overlapY[overlapYPos]
                overlapYPos += 1
       
               }
              else{
                y += individualImageHeight
               }
           
          }
      }

        function getPopUpOrientation(clickedImage, billCoordinates){
          clickedImageXPos = clickedImage.getAttribute('x') - edgeMargin
          clickedImageYPos = clickedImage.getAttribute('y') - edgeMargin
      
          var midXPoint = (billCoordinates.x2-billCoordinates.x1)/2
          var midYPoint = (billCoordinates.y2-billCoordinates.y1)/2
          var position;
        
          if (clickedImageXPos > midXPoint && clickedImageYPos < midYPoint){
            position = 'topRight'
          }
          else if (clickedImageXPos > midXPoint && clickedImageYPos > midYPoint){
            position = 'bottomRight'
          }
          else if (clickedImageXPos < midXPoint && clickedImageYPos < midYPoint){
            position = 'topLeft'
          }
          else if (clickedImageXPos < midXPoint && clickedImageYPos > midYPoint){
            position = 'bottomLeft'
          }
          return position
      
        }

        function calculateCenterOfBox(id){
          var ids = id.split(".")
          var idX = ids[0]
          var idY = ids[1]

          centerX = idX * individualImageWidth + (individualImageWidth/2)
          centerY = idY * individualImageHeight + (individualImageHeight/2)

          return {'x': centerX, 'y': centerY}
        }

        function adjustXYPos(clickedPosition, position){
          var adjustedX;
          var adjustedY;
      
          if (position == 'topLeft'){
            adjustedX = clickedPosition.x - popupWidth/2 + individualImageWidth
            adjustedY = clickedPosition.y + 12
          }
          else if (position == 'bottomLeft'){
            adjustedX = clickedPosition.x - popupWidth/2 + individualImageWidth
            adjustedY = clickedPosition.y - popupHeight - 10
          }
          else if (position == 'topRight'){
            adjustedX = clickedPosition.x  - popupWidth/2 + individualImageWidth
            adjustedY = clickedPosition.y + 12
          }
          else if (position == 'bottomRight'){
            adjustedX = clickedPosition.x  - popupWidth/2 + individualImageWidth
            adjustedY = clickedPosition.y  - popupHeight - 10
          }

          var leftOverhang = clickedPosition.x - popupWidth/2 + overhangCorrection


          var rightOverhang =  (billWidth + edgeMargin) - ( clickedPosition.x + popupWidth/2 - edgeMargin/2)
          if ( leftOverhang < 0){
            adjustedX = adjustedX + (-1 * leftOverhang)
          } 
          if (rightOverhang < 0){
            adjustedX = adjustedX  + rightOverhang 
          }
          return {'x': adjustedX, 'y': adjustedY}
        }

       

        function getBillCoordinates(){
          return {'x1': edgeMargin, 'y1': edgeMargin, 'x2': billWidth + edgeMargin, 'y2': billHeight + edgeMargin}
        }

        function createPopUpBox(clickedImage){
          clearInterval(timeout)
          clickedImage = event.srcElement
         
          billCoordinates = getBillCoordinates()
          position = getPopUpOrientation(clickedImage, billCoordinates)
          clickedElementPosition = {'x': parseInt(clickedImage.getAttribute('x')), 'y': parseInt(clickedImage.getAttribute('y'))}
          adjustedPosition = adjustXYPos(clickedElementPosition, position)
          
          var svgns = "http://www.w3.org/2000/svg";
          var popupContainer = document.createElementNS(svgns, 'g');
          popupContainer.id = "popupContainer"
          popupContainer.style = 'fill: rgb(255,255,255,1);'
          
          var popup = document.createElementNS(svgns, 'rect');
          popup.id = 'popup'
          popup.setAttributeNS(null, 'x', adjustedPosition.x);
          popup.setAttributeNS(null, 'y', adjustedPosition.y);
          popup.setAttributeNS(null, 'height', popupHeight);
          popup.setAttributeNS(null, 'width', popupWidth);
          popup.style = 'fill: rgb(255,255,255,1);'
          popupContainer.appendChild(popup)

          var pointer = document.createElementNS(svgns, 'polygon');
          pointer.id = 'pointer'
          pointer.style.fill = "white"

          if (position.includes('top')){
            pointer.setAttribute('points', `${clickedElementPosition.x + 4} ${adjustedPosition.y}, ${clickedElementPosition.x + individualImageWidth/2 + 3 } ${adjustedPosition.y-7}, ${clickedElementPosition.x + individualImageWidth + 2} ${adjustedPosition.y}`)
          }

          else{
            pointer.setAttribute('points', `${clickedElementPosition.x + 4} ${adjustedPosition.y+90}, ${clickedElementPosition.x + individualImageWidth/2 + 3 } ${adjustedPosition.y+97}, ${clickedElementPosition.x + individualImageWidth + 2} ${adjustedPosition.y+90}`)
          }

          document.getElementById('billContainer').appendChild(pointer)

          var popupInnerBox = document.createElementNS(svgns, 'rect');
          popupInnerBox.id = 'popupInnerBox'
          popupInnerBox.setAttributeNS(null, 'x', adjustedPosition.x+popupSideMargin);
          popupInnerBox.setAttributeNS(null, 'y', adjustedPosition.y+popupSideMargin);
          popupInnerBox.setAttributeNS(null, 'height', popupHeight-(popupSideMargin*2));
          popupInnerBox.setAttributeNS(null, 'width', popupWidth-(popupSideMargin*2));
          popupInnerBox.style = ' fill: rgb(175,175,175);'
          popupContainer.appendChild(popupInnerBox)

          var popupLeftSide = document.createElementNS('http://www.w3.org/2000/svg', 'image');
          popupLeftSide.id = `popupLeftSide`
          popupLeftSide.setAttributeNS(null, 'x', adjustedPosition.x+popupSideMargin);
          popupLeftSide.setAttributeNS(null, 'y', adjustedPosition.y+popupSideMargin+1);
          popupLeftSide.setAttributeNS(null, 'height', popupSideHeight);
          popupLeftSide.setAttributeNS(null, 'width', popupSideWidth);
          popupLeftSide.setAttributeNS(null, 'href', `data/images/${clickedImage.id}.jpg`);
          popupContainer.appendChild(popupLeftSide);
          
          var popupRightSide = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          popupRightSide.id = 'drawingContainer'
          popupRightSide.setAttributeNS(null, 'x', (adjustedPosition.x+popupSideMargin + popupSideWidth) - popupSideMargin*2 -1);
          popupRightSide.setAttributeNS(null, 'y', adjustedPosition.y+popupSideMargin+1);
          popupRightSide.setAttributeNS(null, 'height', popupSideHeight);
          popupRightSide.setAttributeNS(null, 'width', popupSideWidth);
          popupRightSide.setAttributeNS(null, 'href', `data/images/${clickedImage.id}.jpg`);
          popupContainer.appendChild(popupRightSide);

          var background = document.createElementNS(svgns, 'rect');
          background.setAttributeNS(null, 'x',0);
          background.setAttributeNS(null, 'y', 0);
          background.setAttributeNS(null, 'height', popupSideHeight);
          background.setAttributeNS(null, 'width', popupSideWidth);
          background.style = ' fill: white;'

          popupRightSide.append(background)

          popupContainer.drawing = true

          fetch(`data/drawing_instructions/${clickedImage.id}.txt`)
          .then((res) => res.text())
          .then((text) => {
            function parseCommand(i) {
            
          
              if ( i < commands.length - 1){

                command = commands[i]
                if (command.length > 0){
                  parts = commands[i].split(".")
                  
                  if (parts[0] == 'c'){
                    color = rgbToHex(parts[1], parts[2], parts[3])
                  }

                  else{
                    if (parts[0] == 's'){
                      thickness= (parts[1] / 0.85) * scale
                    }

                    else {
                        thickness = thickness
                        var newLine = document.createElementNS('http://www.w3.org/2000/svg','line');
                        
                        newLine.setAttribute('x1', parts[0] * scale);
                        newLine.setAttribute('y1', parts[1] * scale);
                        newLine.setAttribute('x2',  (parts[2]) * scale );
                        newLine.setAttribute('y2',(parts[3] * scale));
                        newLine.setAttribute('stroke-linecap', "round");
                        newLine.style = ` stroke:${color}; stroke-width: ${thickness}; `
                      
                        var container = document.getElementById('drawingContainer')
                        container.appendChild(newLine)
                        
                    }
                  }
                }
              }
              i++
              timeout = setTimeout(function () {
                  parseCommand(i);
              }, 6);
            }
            
            
            // do something with "text"
            commands = text.split("drawing=")[1]
            curCommand = 0;
            thickness = 1;
            color = 'black';
            scale = 0.5
            commands = commands.split("_");
            numCommands = commands.length;
            var i = 0;

            parseCommand(i)
          })
          .catch((e) => console.error(e));
        
          document.getElementById('bill').appendChild(popupContainer);
        
        }

        setupBillSize()
        
        function distance(x1, y1, x2, y2) {
          var dx = x2-x1
          var dy = y2-y1
          return Math.sqrt(dx*dx+dy*dy);
        }


        /* MOUSE FUNCTIONS */

        window.addEventListener('mousemove', function (event) {
          var offSetRect = document.getElementById('billContainer').getBoundingClientRect()
          const localX = event.clientX - offSetRect.left ;
          const localY = event.clientY - offSetRect.top  ;
          localMousePos = { x: localX, y: localY };
          
          overX = Math.floor((localX)/8)*8;
          overY = Math.floor((localY)/3.4)*3.4;

          overX = Math.round(overX * 10) / 10
          overY = Math.round(overY * 10) / 10;

        

          rectX = (overX/8) + 1
          rectY = (overY/3.4) + 1

          rectX = Math.floor(rectX)
          rectY = Math.floor(rectY)

          id = `${rectX}.${rectY}`

          if (selectedRect != null){
              selectedRect.style= "fill: rgb(255,255,255,0);  stroke:red; stroke-width:0";
            }

          if (overX > -1 && overY > -1 && overX <= actualBillWidth && overY <= actualBillHeight){
            console.log(`x within bill: ${localX}, y within bill: ${localY}`)
            console.log(`adjusted x: ${overX} adjusted y: ${overY}`)

            if (clickedRect != null){
             
              if (distance(clickedRect.getAttribute('x'), clickedRect.getAttribute('y'), localX, localY)>10) {
                clickedRect = null;
                selectedRect.style= "fill: rgb(255,255,255,0);  stroke:red; stroke-width:0";
                    var alreadyExists = document.getElementById('popupContainer');
                  var parent = alreadyExists.parentNode
                  parent.removeChild(alreadyExists)
                  var pointer = document.getElementById('pointer');
                  var pointerParent = pointer.parentNode
                  pointerParent.removeChild(pointer)
                clearInterval(timeout)
              }
              else{
                console.log(clickedRect)
              }
              
            }
            
           
            selectedRect = document.getElementById(id)
            selectedRect.style = "fill: rgb(255,255,255,0);  stroke:red; stroke-width:1";
          

          }
          

         
            
         
        
        }, false);


        
      document.getElementById('bill').addEventListener('click', function (event) {
        clickedRect = selectedRect
        clickedRect.style="fill:red; stroke:red; stroke-width:1; "
        if (document.getElementById('popupContainer') != null ){
              var alreadyExists = document.getElementById('popupContainer');
              var parent = alreadyExists.parentNode
              parent.removeChild(alreadyExists)
              var pointer = document.getElementById('pointer');
              var pointerParent = pointer.parentNode
              pointerParent.removeChild(pointer)
            }
            clearInterval(timeout)
            createPopUpBox(event.srcElement)
          

      }, false);

        /* ------------------------------------------------------------------------------------------------------------------------------------------------------ */

      </script>

    </body>

</html>