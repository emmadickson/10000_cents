<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10000 Cents</title>
    <style>
      body{
        background-color: rgb(248,248,248);
      }
      #bill_container{
        width:100%;
        display: flex;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <div id="bill_container">

     
   
      <svg id="bill">
        <g  id="videoContainer">
          <foreignobject  id="billForeignObject" x="0" y="0" width="800" height="340">
            <video width="800" height="340" autoplay="true" muted="true" >
              <source src="data/bill.mov" type="video/mp4">
            </video>
          </foreignobject>
        </g>
        <g  id="billContainer"></g>
      </svg> 

    </div>
   
    <script>
     
      var individualImageWidth = 8;
      var individualImageHeight = 3.4;
      var billHeight =individualImageHeight * 100; 
      var billWidth = individualImageWidth * 100;
      var popupHeight = 90;
      var popupWidth = 400;
      var edgeMargin = 50;
      var svgns = "http://www.w3.org/2000/svg";

      function setupBillSize(){
       
        var bill = document.getElementById('bill')
        bill.style.width = `${billWidth+(edgeMargin*2)}px`
        bill.style.height = `${billHeight+ (edgeMargin*2)}px`

        var billLoadForeignObject = document.getElementById('billForeignObject')
        billLoadForeignObject.setAttribute('x', edgeMargin)
        billLoadForeignObject.setAttribute('y', edgeMargin)

        y = edgeMargin;
      
        for (var i = 1; i < 100; i++){
            x = edgeMargin; 
          
            for (var j = 1; j < 100; j++){
              
                var rect = document.createElementNS(svgns, 'rect');
                rect.id = `${j}.${i}`
                rect.setAttributeNS(null, 'x', x);
                rect.setAttributeNS(null, 'y', y);
                rect.setAttributeNS(null, 'height', individualImageHeight);
                rect.setAttributeNS(null, 'width', individualImageWidth);
                rect.style.fill = 'rgb(255,255,255,0)'
                document.getElementById('billContainer').appendChild(rect);
                x += individualImageWidth
            }
            y += individualImageHeight
        }
     }

      function getPopUpOrientation(clickedImage, billCoordinates){
        clickedImageXPos = clickedImage.getAttribute('x') - edgeMargin
        clickedImageYPos = clickedImage.getAttribute('y') - edgeMargin
     
        var midXPoint = (billCoordinates.x2-billCoordinates.x1)/2
        var midYPoint = (billCoordinates.y2-billCoordinates.y1)/2
        var position;
        console.log(midXPoint)
        console.log(midYPoint)
        if (clickedImageXPos > midXPoint && clickedImageYPos < midYPoint){
          position = 'topRight'
        }
        else if (clickedImageXPos > midXPoint && clickedImageYPos > midYPoint){
          position = 'bottomRight'
        }
        else if (clickedImageXPos < midXPoint && clickedImageYPos < midYPoint){
          position = 'topLeft'
        }
        else if (clickedImageXPos < midXPoint && clickedImageYPos > midYPoint){
          position = 'bottomLeft'
        }
        console.log(position)
        return position
    
      }

      function calculateCenterOfBox(id){
        var ids = id.split(".")
        var idX = ids[0]
        var idY = ids[1]

        centerX = idX * individualImageWidth
        centerY = idY * individualImageHeight

        return {'x': centerX, 'y': centerY}
      }

      function adjustXYPos(centerPos, position){
        var adjustedX;
        var adjustedY;
        if (position == 'topLeft'){
          adjustedX = centerPos.x + (individualImageWidth/2)
          adjustedY = centerPos.y - (individualImageHeight/2)
        }
        else if (position == 'bottomLeft'){
          adjustedX = centerPos.x + (individualImageWidth/2) 
          adjustedY = centerPos.y + (individualImageHeight/2) - popupHeight
        }
        else if (position == 'topRight'){
          adjustedX = centerPos.x - (individualImageWidth/2) - popupWidth
          adjustedY = centerPos.y - (individualImageHeight/2)
        }
        else if (position == 'bottomRight'){
          adjustedX = centerPos.x - (individualImageWidth/2) - popupWidth
          adjustedY = centerPos.y + (individualImageHeight/2) - popupHeight
        }
        return {'x': adjustedX, 'y': adjustedY}
      }

      function readTextFile(file) {
        var rawFile = new XMLHttpRequest();
        rawFile.open("GET", file, false);
        rawFile.onreadystatechange = function () {
          if(rawFile.readyState === 4)  {
            if(rawFile.status === 200 || rawFile.status == 0) {
              var allText = rawFile.responseText;
              console.log(allText);
            }
          }
        }
        rawFile.send(null);
      }
      
      function rgbToHex(r, g, b) {
        return "#" + (1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1);
      }

      function getBillCoordinates(){
        return {'x1': edgeMargin, 'y1': edgeMargin, 'x2': billWidth + edgeMargin, 'y2': billHeight + edgeMargin}
      }

      function createPopUpBox(clickedImage){
        event.srcElement.style="fill: red; stroke:red; stroke-width:1;" 

        billCoordinates = getBillCoordinates()
        position = getPopUpOrientation(clickedImage, billCoordinates)
        if (position != -1){
          centerPos = calculateCenterOfBox(clickedImage.id)
          adjustedPostion = adjustXYPos(centerPos, position)
        
          
          var alreadyExists = document.getElementById('popupContainer');

          if (alreadyExists){
            var parent = alreadyExists.parentNode
            parent.removeChild(alreadyExists)
          }
      
          var svgns = "http://www.w3.org/2000/svg";
          var popupContainer = document.createElementNS(svgns, 'g');
          popupContainer.id = "popupContainer"
          
          
          var popup = document.createElementNS(svgns, 'rect');
          popup.id = 'popup'
          popup.setAttributeNS(null, 'x', adjustedPostion.x);
          popup.setAttributeNS(null, 'y', adjustedPostion.y);
          popup.setAttributeNS(null, 'height', popupHeight);
          popup.setAttributeNS(null, 'width', popupWidth);
          popup.style = 'fill: rgb(255,255,255,1);'
          popupContainer.appendChild(popup)

          var popupBillImage = document.createElementNS('http://www.w3.org/2000/svg', 'image');
          popupBillImage.id = `popupBillImage`
          popupBillImage.setAttributeNS(null, 'x', adjustedPostion.x);
          popupBillImage.setAttributeNS(null, 'y', adjustedPostion.y);
          popupBillImage.setAttributeNS(null, 'height', popupHeight);
          popupBillImage.setAttributeNS(null, 'width', popupWidth/2);
          popupBillImage.setAttributeNS(null, 'href', `data/images/${clickedImage.id}.jpg`);
          popupContainer.appendChild(popupBillImage);
        
          fetch(`data/drawing_instructions/${clickedImage.id}.txt`)
          .then((res) => res.text())
          .then((text) => {
            function parseCommand(){
            
              if ( i < commands.length - 1){
                command = commands[i]
                if (command.length > 0){
                  parts = commands[i].split(".")
                  
                  if (parts[0] == 'c'){
                    color = rgbToHex(parts[1], parts[2], parts[3])
                  }

                  else{
                    if (parts[0] == 's'){
                      thickness= parts[1] / 0.85 * scale
                    }

                    else {
                        thickness = thickness
                        var newLine = document.createElementNS('http://www.w3.org/2000/svg','line');
                        
                        newLine.setAttribute('x1', adjustedPostion.x + popupWidth/2 + (parts[0] * scale));
                        newLine.setAttribute('y1', adjustedPostion.y + (parts[1] * scale));
                        newLine.setAttribute('x2', adjustedPostion.x + popupWidth/2 + (parts[2]) * scale );
                        newLine.setAttribute('y2', adjustedPostion.y + parts[3] * scale);
                        newLine.setAttribute('stroke-linecap', "round");

                        newLine.style = ` stroke:${color}; stroke-width: ${thickness}; `
                        popupContainer.append(newLine);
                    }
                  }
                }
              }
              i++
              setTimeout(parseCommand, 10)            }

            // do something with "text"
            commands = text.split("drawing=")[1]

            curCommand = 0;
            thickness = 1;
            color = 'black';
            scale = 0.5
            commands = commands.split("_");
            numCommands = commands.length;
            
            var i = 0;

            setTimeout(parseCommand,10)  
          })
          .catch((e) => console.error(e));
        
          document.getElementById('bill').appendChild(popupContainer);
        }
      }

      setupBillSize()

      document.getElementById('bill').addEventListener('click', function (event) {
      
        if (event.srcElement.tagName == 'rect'){
          createPopUpBox(event.srcElement)
        }
      }, false);

      document.getElementById('bill').addEventListener('mouseover', function (event) {
        if (event.srcElement.tagName == 'rect'){
          xValue = event.srcElement.x.baseVal.value
          yValue = event.srcElement.y.baseVal.value

          if (xValue > edgeMargin && yValue > edgeMargin){
            event.srcElement.style="fill: rgb(255,255,255,0); stroke:red; stroke-width:1;" 
          }
        }
      
      }, false);

      document.getElementById('bill').addEventListener('mouseout', function (event) {
        if (event.srcElement.tagName == 'rect'){
          xValue = event.srcElement.x.baseVal.value
          yValue = event.srcElement.y.baseVal.value

          if (xValue > edgeMargin && yValue > edgeMargin){
            event.srcElement.style="fill: rgb(255,255,255,0)" 
          }
        }
       
      }, false);

    </script>
	  <script src="index.js"></script>
  </body>
</html>