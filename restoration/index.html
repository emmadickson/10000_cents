<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10000 Cents</title>
    <style>
      body{
        background-color: rgb(248,248,248);
      }
      #bill_container{
        width:100%;
        display: flex;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <div id="bill_container">
     <svg id="bill">
      <g>
        <foreignObject x="0" y="0" width="800" height="340">
          <video width="800"  muted autoplay>
            <source src="data/bill.mov" type="video/mp4">
          </video>
        </foreignObject>
      </g>
    </svg> 
    </div>
   
    <script>
     
      var individualImageWidth = 8;
      var individualImageHeight = 3.4;
      var billHeight =individualImageHeight * 100; 
      var billWidth = individualImageWidth * 100;
      var popupHeight = 90;
      var popupWidth = 400;

      function setupBillSize(){
       
       var bill = document.getElementById('bill')
       bill.style.width = `${billWidth}px`
       bill.style.height = `${billHeight}px`

      /* var billBackground = document.createElementNS('http://www.w3.org/2000/svg', 'image');
       billBackground.id = `billImage`
       billBackground.setAttributeNS(null, 'x', 0);
       billBackground.setAttributeNS(null, 'y', 0);
       billBackground.setAttributeNS(null, 'height', '100vh');
       billBackground.setAttributeNS(null, 'width', '100vw');
       billBackground.setAttributeNS(null, 'href', 'data/bill.png');
       billBackground.setAttribute('preserveAspectRatio', "xMidYMax slice")
       document.getElementById('bill').appendChild(billBackground);
*/
       y = 0;
      
       for (var i = 1; i < 100; i++){
           x = 0; 
         
           for (var j = 1; j < 100; j++){
               var svgns = "http://www.w3.org/2000/svg";
               var rect = document.createElementNS(svgns, 'rect');
               rect.id = `${j}.${i}`
               rect.setAttributeNS(null, 'x', x);
               rect.setAttributeNS(null, 'y', y);
               rect.setAttributeNS(null, 'height', individualImageHeight);
               rect.setAttributeNS(null, 'width', individualImageWidth);
               rect.style.fill = 'rgb(255,255,255)'
               rect.style.fillOpacity = '0'
               document.getElementById('bill').appendChild(rect);
               x += individualImageWidth
           }
           y += individualImageHeight
       }
      }

      function getPopUpOrientation(clickedImage){
        clickedImageXPos = clickedImage.getAttribute('x')
        clickedImageYPos = clickedImage.getAttribute('y')

        var midXPoint = billWidth/2
        var midYPoint = billHeight/2
        var position;

        if (clickedImageXPos > midXPoint && clickedImageYPos < midYPoint){
          position = 'topRight'
        }
        else if (clickedImageXPos > midXPoint && clickedImageYPos > midYPoint){
          position = 'bottomRight'
        }
        else if (clickedImageXPos < midXPoint && clickedImageYPos < midYPoint){
          position = 'topLeft'
        }
        else if (clickedImageXPos < midXPoint && clickedImageYPos > midYPoint){
          position = 'bottomLeft'
        }
        return position
      }

      function calculateCenterOfBox(id){
        var ids = id.split(".")
        var idX = ids[0]
        var idY = ids[1]

        centerX = idX * individualImageWidth
        centerY = idY * individualImageHeight

        return {'x': centerX, 'y': centerY}
      }

      function adjustXYPos(centerPos, position){
        var adjustedX;
        var adjustedY;
        if (position == 'topLeft'){
          adjustedX = centerPos.x + (individualImageWidth/2)
          adjustedY = centerPos.y - (individualImageHeight/2)
        }
        else if (position == 'bottomLeft'){
          adjustedX = centerPos.x + (individualImageWidth/2) 
          adjustedY = centerPos.y + (individualImageHeight/2) - popupHeight
        }
        else if (position == 'topRight'){
          adjustedX = centerPos.x - (individualImageWidth/2) - popupWidth
          adjustedY = centerPos.y - (individualImageHeight/2)
        }
        else if (position == 'bottomRight'){
          adjustedX = centerPos.x - (individualImageWidth/2) - popupWidth
          adjustedY = centerPos.y + (individualImageHeight/2) - popupHeight
        }
        return {'x': adjustedX, 'y': adjustedY}
      }

      function createLeftHandSize(){
        
      }
      function readTextFile(file) {
        var rawFile = new XMLHttpRequest();
        rawFile.open("GET", file, false);
        rawFile.onreadystatechange = function () {
          if(rawFile.readyState === 4)  {
            if(rawFile.status === 200 || rawFile.status == 0) {
              var allText = rawFile.responseText;
              console.log(allText);
            }
          }
        }
        rawFile.send(null);
      }
      function rgbToHex(r, g, b) {
        return "#" + (1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1);
      }

   
 
      function createPopUpBox(clickedImage){
       
        position = getPopUpOrientation(clickedImage)
        centerPos = calculateCenterOfBox(clickedImage.id)
        adjustedPostion = adjustXYPos(centerPos, position)

        var alreadyExists = document.getElementById('popup');
     
        if (alreadyExists){
          var parent = alreadyExists.parentNode
          parent.removeChild(alreadyExists)
        }
    
        var svgns = "http://www.w3.org/2000/svg";
        var popup = document.createElementNS(svgns, 'rect');
        popup.id = 'popup'
        popup.setAttributeNS(null, 'x', adjustedPostion.x);
        popup.setAttributeNS(null, 'y', adjustedPostion.y);
        popup.setAttributeNS(null, 'height', popupHeight);
        popup.setAttributeNS(null, 'width', popupWidth);

        document.getElementById('bill').appendChild(popup);

        var popupBillImage = document.createElementNS('http://www.w3.org/2000/svg', 'image');
        popupBillImage.id = `popupBillImage`
        popupBillImage.setAttributeNS(null, 'x', adjustedPostion.x);
        popupBillImage.setAttributeNS(null, 'y', adjustedPostion.y);
        popupBillImage.setAttributeNS(null, 'height', popupHeight);
        popupBillImage.setAttributeNS(null, 'width', popupWidth/2);
        popupBillImage.setAttributeNS(null, 'href', `data/images/${clickedImage.id}.jpg`);
       
        document.getElementById('bill').appendChild(popupBillImage);
      
          fetch(`data/drawing_instructions/${clickedImage.id}.txt`)
          .then((res) => res.text())
          .then((text) => {
            function parseCommand(){
           
              if ( i < commands.length - 1){
                command = commands[i]
                if (command.length > 0){
                  parts = commands[i].split(".")
                  
                  if (parts[0] == 'c'){
                    color = rgbToHex(parts[1], parts[2], parts[3])
                  }

                  else{
                    if (parts[0] == 's'){
                      thickness= parts[1] * 0.85*0.5
                    }

                    else {
                        thickness = thickness
                        var newLine = document.createElementNS('http://www.w3.org/2000/svg','line');
                        newLine.setAttribute('id','line2');
                        newLine.setAttribute('x1', adjustedPostion.x + popupWidth/2 + (parts[0] * scale));
                        newLine.setAttribute('y1', adjustedPostion.y + (parts[1] * scale));
                        newLine.setAttribute('x2', adjustedPostion.x + popupWidth/2 + (parts[2] * scale));
                        newLine.setAttribute('y2', adjustedPostion.y + (parts[3] * scale));
                        newLine.setAttribute("stroke", color)
                        newLine.setAttribute("stroke-width", thickness)
                        document.getElementById('bill').append(newLine);
                    }
                  }
                }
              }
              i++
              setTimeout(parseCommand, 50)
              }

            // do something with "text"
            commands = text.split("drawing=")[1]

            curCommand = 0;
            thickness = 1;
            color = 'black';
            scale = 0.5
            commands = commands.split("_");
            numCommands = commands.length;
            
            var i = 0;

            setTimeout(parseCommand,50)  
          })
          .catch((e) => console.error(e));
      

      }

      setupBillSize()

      document.getElementById('bill').addEventListener('click', function (event) {
        createPopUpBox(event.srcElement)
      }, false);

    </script>
	  <script src="index.js"></script>
  </body>
</html>